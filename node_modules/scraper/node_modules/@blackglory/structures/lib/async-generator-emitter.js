import { go, goAsyncGenerator } from '@blackglory/go';
export class AsyncGeneratorEmitter {
    map = new Map();
    get [Symbol.toStringTag]() {
        return this.constructor.name;
    }
    on(event, listener) {
        const set = go(() => {
            const set = this.map.get(event);
            if (set) {
                return set;
            }
            else {
                const set = new Set();
                this.map.set(event, set);
                return set;
            }
        });
        set.add(handler);
        return () => {
            const handlers = this.map.get(event);
            if (handlers) {
                const deleted = handlers.delete(handler);
                if (deleted && handlers.size === 0) {
                    this.map.delete(event);
                }
            }
        };
        async function* handler(...args) {
            yield* goAsyncGenerator(() => listener(...args));
        }
    }
    once(event, listener) {
        const removeListener = this.on(event, async function* (...args) {
            yield* goAsyncGenerator(() => listener(...args));
            removeListener();
        });
        return removeListener;
    }
    async *emit(event, ...args) {
        const listeners = this.map.get(event);
        if (listeners) {
            for (const listener of listeners) {
                yield* goAsyncGenerator(() => listener(...args));
            }
        }
    }
    removeAllListeners(event) {
        this.map.get(event)?.clear();
    }
}
//# sourceMappingURL=async-generator-emitter.js.map