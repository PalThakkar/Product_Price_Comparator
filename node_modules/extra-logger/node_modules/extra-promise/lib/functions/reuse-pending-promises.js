import { stringify } from 'extra-json-stable-stringify';
import { HashMap } from '@blackglory/structures';
export function reusePendingPromises(fn, options) {
    var _a;
    const pendings = new HashMap((_a = options === null || options === void 0 ? void 0 : options.createKey) !== null && _a !== void 0 ? _a : stringify);
    return async function (...args) {
        const [value, isReuse] = await reusableFunction.apply(this, args);
        return (options === null || options === void 0 ? void 0 : options.verbose) ? [value, isReuse] : value;
    };
    async function reusableFunction(...args) {
        const result = pendings.get(args);
        if (result) {
            return [await result, true];
        }
        else {
            const promise = Promise.resolve(fn.apply(this, args))
                .finally(() => pendings.delete(args));
            pendings.set(args, promise);
            return [await promise, false];
        }
    }
}
//# sourceMappingURL=reuse-pending-promises.js.map