import { validateConcurrency } from "../utils/validate-concurrency.js";
export function parallel(tasks, concurrency = Infinity) {
    validateConcurrency('concurrency', concurrency);
    return new Promise((resolve, reject) => {
        let running = 0;
        let promisePending = true;
        const iterator = tasks[Symbol.iterator]();
        let done;
        for (let i = 0; !done && i < concurrency; i++) {
            next();
        }
        async function next() {
            if (!promisePending)
                return;
            if (done && running === 0)
                return resolveGracefully();
            let value;
            try {
                ({ value, done } = iterator.next());
            }
            catch (e) {
                return rejectGracefully(e);
            }
            if (done) {
                if (running === 0)
                    resolveGracefully();
                return;
            }
            const task = value;
            running++;
            try {
                await task();
            }
            catch (e) {
                return rejectGracefully(e);
            }
            running--;
            next();
        }
        function resolveGracefully() {
            var _a;
            promisePending = false;
            if (!done) {
                (_a = iterator.return) === null || _a === void 0 ? void 0 : _a.call(iterator);
            }
            resolve();
        }
        function rejectGracefully(reason) {
            var _a;
            promisePending = false;
            if (!done) {
                (_a = iterator.return) === null || _a === void 0 ? void 0 : _a.call(iterator);
            }
            reject(reason);
        }
    });
}
//# sourceMappingURL=parallel.js.map